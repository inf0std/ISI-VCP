<!DOCTYPE html>
<html>
  <head>
    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.6.0/socket.io.js"
      integrity="sha512-rwu37NnL8piEGiFhe2c5j4GahN+gFsIn9k/0hkRY44iz0pc81tBNaUN56qF8X4fy+5pgAAgYi2C9FXdetne5sQ=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    ></script>
    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/simple-peer/9.11.1/simplepeer.min.js"
      integrity="sha512-0f7Ahsuvr+/P2btTY4mZIw9Vl23lS6LY/Y7amdkmUg2dqsUF+cTe4QjWvj/NIBHJoGksOiqndKQuI9yzn2hB0g=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    ></script>
  </head>
  <body>
    <script>
      let socket = io("http://localhost:8080");
      const queryString = window.location.search;
      const params = new URLSearchParams(queryString);
      let peers = [];
      let localStream = null;
      let roomid = params.get("roomid");
      socket.emit("join", { roomid });

      //const peer = new SimplePeer({ initiator: true });
      const createPeer = (init) => {
        return new SimplePeer({ initiator: init, trickle: false, localStream });
      };
      navigator.mediaDevices
        .getUserMedia({ video: true, audio: true })
        .then((stream) => (localStream = stream));

      socket.emit("join", roomid);
      socket.on("joined", ({ roomid, socketid }) => {
        const peer = createPeer(true);
        peer.on("signal", (signal) => {
          socket.emit("offre", { signal, socketid });
        });
        peers.push({ socketid, peer });
      });

      socket.on("offre", ({ signal, socketid }) => {
        console.log("jai recu une offre", socketid);
        let peer = createPeer(false);
        peer.on("signal", (signal) => {
          socket.emit("answer", { signal, socketid });
          console.log("jai recu un signal", socketid);
        });
        peer.signal(signal);
      });

      socket.on("answer", ({ signal, socketid }) => {
        console.log("jai recu un answer", socketid);
        let peer = peers.find((peer) => peer.socketid == socketid).peer;
        peer.signal(signal);
      });
    </script>
  </body>
</html>
